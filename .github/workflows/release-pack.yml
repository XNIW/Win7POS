name: release-pack

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  pack:
    runs-on: windows-latest
    env:
      DOTNET_NOLOGO: "true"
      DOTNET_CLI_TELEMETRY_OPTOUT: "true"
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - run: dotnet --info

      - name: Build CLI Release
        run: dotnet restore src/Win7POS.Cli/Win7POS.Cli.csproj && dotnet build src/Win7POS.Cli/Win7POS.Cli.csproj -c Release --no-restore

      - name: Selftest (keepdb)
        run: dotnet run --project src/Win7POS.Cli/Win7POS.Cli.csproj -c Release --no-build -- --selftest --keepdb

      - name: Build WPF Release x86
        run: dotnet restore src/Win7POS.Wpf/Win7POS.Wpf.csproj && dotnet build src/Win7POS.Wpf/Win7POS.Wpf.csproj -c Release -p:Platform=x86 -p:PlatformTarget=x86 --no-restore

      - name: Create release pack zip
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          New-Item -ItemType Directory -Force -Path "dist/Win7POS" | Out-Null

          $wpfOutput = Get-ChildItem -Path "src/Win7POS.Wpf/bin" -Directory -Recurse |
            Where-Object { Test-Path (Join-Path $_.FullName "Win7POS.Wpf.exe") } |
            Select-Object -First 1
          if ($null -eq $wpfOutput) { throw "WPF output folder not found." }
          Copy-Item -Path (Join-Path $wpfOutput.FullName "*") -Destination "dist/Win7POS" -Recurse -Force

          $cliOutput = Get-ChildItem -Path "src/Win7POS.Cli/bin" -Directory -Recurse |
            Where-Object { Test-Path (Join-Path $_.FullName "Win7POS.Cli.dll") } |
            Select-Object -First 1
          if ($null -ne $cliOutput) {
            New-Item -ItemType Directory -Force -Path "dist/Win7POS/cli" | Out-Null
            Copy-Item -Path (Join-Path $cliOutput.FullName "*") -Destination "dist/Win7POS/cli" -Recurse -Force
          }

          $readme = @"
          Win7POS Release Pack

          Requirements:
          - Windows 7+ with .NET Framework 4.8 for WPF app

          Important paths:
          - Data: %ProgramData%\Win7POS
          - Logs: %ProgramData%\Win7POS\logs
          - Backups: %ProgramData%\Win7POS\backups
          - Exports: %ProgramData%\Win7POS\exports
          - Receipts: %ProgramData%\Win7POS\receipts

          Notes:
          - WPF executable: Win7POS.Wpf.exe
          - CLI (optional) files are under .\cli
          - Verify package completeness with RELEASE_CHECKLIST.txt
          "@
          Set-Content -Path "dist/Win7POS/README_RUN.txt" -Value $readme -Encoding UTF8

          $checklist = @"
          Win7POS Release Pack Checklist

          Verify inside zip Win7POS_yyyyMMdd_HHmm.zip -> dist/Win7POS:

          [WPF - required]
          [ ] Win7POS.Wpf.exe (or current app exe name)
          [ ] Win7POS.Wpf.exe.config (if generated by build)
          [ ] Win7POS.Core.dll
          [ ] Win7POS.Data.dll
          [ ] All managed dependency DLLs required by the app

          [SQLite x86 runtime - critical]
          If using Microsoft.Data.Sqlite:
          [ ] Microsoft.Data.Sqlite.dll
          [ ] SQLitePCLRaw.* assemblies
          [ ] e_sqlite3.dll (x86 native)

          If using System.Data.SQLite:
          [ ] System.Data.SQLite.dll
          [ ] SQLite.Interop.dll (x86 native)

          IMPORTANT:
          - Missing x86 native SQLite DLL can cause DB-open crash on Win7.

          [CLI - optional but recommended]
          [ ] dist/Win7POS/cli/Win7POS.Cli.exe (or dll/runtime output)
          [ ] CLI dependency DLLs

          [Docs]
          [ ] README_RUN.txt includes .NET Framework 4.8 note
          [ ] README_RUN.txt includes ProgramData paths:
              %ProgramData%\Win7POS\...
          [ ] README_RUN.txt includes logs/backups/exports/receipts paths
          "@
          Set-Content -Path "dist/Win7POS/RELEASE_CHECKLIST.txt" -Value $checklist -Encoding UTF8

          $stamp = Get-Date -Format "yyyyMMdd_HHmm"
          $zip = "dist/Win7POS_$stamp.zip"
          if (Test-Path $zip) { Remove-Item $zip -Force }
          Compress-Archive -Path "dist/Win7POS/*" -DestinationPath $zip -Force
          Write-Host "Created package: $zip"

      - name: Upload release pack artifact
        uses: actions/upload-artifact@v4
        with:
          name: Win7POS-ReleasePack-x86
          path: dist/Win7POS_*.zip
